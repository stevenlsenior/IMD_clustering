---
title: Hierarchical clustering of English local authorities by sub-domains of the
  English Indices of Multiple Deprivation
author: Steven L. Senior, MPH DPhil MFPH, Specialty Registrar in Public Health, Division
  of Population Health, Health Services Research & Primary Care, University of Manchester,
  UK.
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r set up, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# ABSTRACT  

## Background  

The English Indices of Multiple Deprivation (IMD) is widely used as a measure of deprivation of geographic areas in analyses of health inequalities between places. However, similarly ranked areas can differ substantially in the underlying sub-domains and indicators that are used to calculate the IMD score. These sub-domains and indicators contain a richer set of data that might be useful for classifying local authorities. Clustering methods offer a set of techniques to identify groups of areas with similar patterns of deprivation. This could offer insights into areas that face similar challenges.

## Methods  

Hierarchical agglomerative (i.e. bottom-up) clustering methods were applied to sub-domain scores for 152 upper-tier local authorities. Recent advances in statistical testing allow clusters to be identified that are unlikely to have arisen from random partitioning of a homogeneous group.

## Results  

Five statistically significant clusters of local authorities were identified. These clusters represented local authorities that were: 
1.     Most deprived, predominantly urban;
2.    Least deprived, predominantly rural;
3.    Less deprived, rural;
4.    Deprived, high crime, high barriers to housing; and
5.    Deprived, low education, poor employment, poor health.

## Conclusion

Hierarchical clustering methods can be used to identify five distinct clusters that do not correspond closely to quintiles of deprivation. These methods can be used to draw on the richer set of information contained in the IMD sub-domains and may help to identify places that face similar challenges, and places that appear similar in terms of IMD scores, but that face different challenges.

# INTRODUCTION

INTRODUCTION
The English Indices of Multiple Deprivation (IMD) is a commonly used measure of relative deprivation for geographic areas in England. It is often used for analysing inequalities in health between more and less deprived areas.

The IMD provides an overall score of relative deprivation that is used to rank Lower-Super Output Areas (LSOAs, small geographic areas in England, each with a population about approximately 1,500). The overall score is calculated as a weighted sum of seven sub-domains of deprivation. These sub-domains measure deprivation in: income; employment; health and disability; education, training and skills; crime; access to housing and services; and living environment. Each of the sub-domains is made from one or more indicators. Where more than one indicator is used, indicators are combined using weights determined by factor analysis to create the sub-domain score. The weights used to combine the sub-domains into the overall score were determined using a range of methods including previous research that the income and employment domains should be weighted more heavily, as well as empirical research on public preferences and preferences revealed by relative levels of government spending on each domain (Smith et al. 2015). 

Summary IMD scores are available for larger geographic areas, such as upper-tier local authorities (the upper-most layer of local government in England). For each upper-tier local authority, a number of different ways of combining the deprivation of its LSOAs are used, including average IMD score, average rank, and the proportion of population living in the 10% most deprived LSOAs (Smith et al. 2015). 

In analyses at local authority level, each local authority is typically ranked according to the average score or average rank of its constituent LSOAs, and local authorities are then grouped into quintiles or deciles. This then forms the basis for estimating inequalities in health outcomes. For example, the Public Health Outcomes Framework, a widely used tool for understanding variations in health between English local authorities, has an option to view health indicators by decile of deprivation (Public Health England 2018).

While not wholly arbitrary, the method of grouping areas together in quintiles or deciles may group together areas with quite different deprivation profiles. For example, when upper-tier local authorities are ranked by their average IMD scores, North East Lincolnshire and South Tyneside are ranked as the 25th and 26th most deprived local authorities respectively (out of 152 upper-tier local authorities), both in the second most deprived decile. However their scores on the sub-domains are different: in terms of average health and disability deprivation South Tyneside is ranked 12th most deprived (in the most deprived decile), while North East Lincolnshire is ranked 66th most deprived (in the fifth most deprived decile). As a result, the use of a single overarching ranking system may obscure differences in the types of challenges faced by local authorities, and does not make full use of the rich information contained in the full set of sub-domain scores. 

Statistical clustering methods offer a way to use the richer information contained in the IMD sub-domains or indicators, as well as a less arbitrary way to identify groups of similarly deprived geographic areas.[ref] For example,  Bellis et al (2012) used k-means clustering on health outcomes data and found that the cluster with the worst health outcomes was concentrated in the ex-industrial areas of the North of England. One possible drawback of the k-means approach to clustering is that it requires the researcher to specify the number of clusters to be identified in advance. This could lead to an arbitrary choice of numbers of clusters, or to testing a range of numbers of clusters, which may introduce a risk of multiple testing. An alternative approach is hierarchical clustering, which produces a set of nested clusters, allowing the researcher to describe the clustering structure in the data without arbitrarily specifying a number of clusters to be found. Recent advances in statistical methods make it possible to assess at each ‘branch’ in the tree, whether the resulting clusters are likely to have arisen by chance or not, allowing a clustering structure to be determined without the researcher pre-determining how many clusters will be found (Kimes et al. 2017).

This complements the use of ‘nearest neighbours’ models, such as that produced by the Chartered Institute of Public Finance and Accounting [ref]. This model calculates the Euclidean distance between a given local authority and all other local authorities based on a selection of demographic indicators. This approach is designed to find similar local authorities given an initial local authority, rather than grouping all local authorities based on patterns of deprivation.

The aim of this paper is to apply clustering techniques to domains of deprivation to explore patterns of deprivation among upper-tier local authorities in England. It aims to test the usefulness of unsupervised statistical learning methods in understanding the challenges faced by local authorities.

# METHODS

## Data sources and processing  

```{r installing and loading packages and getting data, message = FALSE, warning = FALSE}
#### Install packages ####
#install.packages(c("devtools", "readxl", "ape", "geojsonio",
#                   "rgdal", "GISTools", "ggalt", "broom", "tidyverse", "FSA",
#                   "cowplot"),
#                 dependencies = TRUE)

#### load packages ####
library(sigclust2)        # For clustering
library(devtools)         # For installing packages
library(readxl)           # For reading excel files
library(ape)              # For plotting dendrograms
library(geojsonio)        # For managing geojson
library(rgdal)            # For mapping
library(GISTools)         # For mapping
library(ggalt)            # For mapping
library(broom)            # For tidying map data
library(tidyverse)        # For data manipulation
library(FSA)              # For Dunn's test
library(knitr)            # For pretty tables
library(cowplot)          # For plotting figures

#### Download files ####

if(!file.exists("imd_la.xlsx")){
  download.file(url = "https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/464465/File_11_ID_2015_Upper-tier_Local_Authority_Summaries.xlsx",
                destfile = "imd_la.xlsx")
}

#### Load data ####

imd_la <- read_xlsx(path = "imd_la.xlsx",
                    sheet = 2)

for(i in 3:11){
  t <- read_xlsx(path = "imd_la.xlsx",
                 sheet = i)
  imd_la <- merge(imd_la, t,
                  by = 1:2)
}

rm(t)

#### Data Pre-Processing ####

# Use average scores
imd_la_subdoms <- dplyr::select(imd_la,
                                1:2,
                                contains("Average score"),
                                -contains("Rank")) 

# rename variables
names(imd_la_subdoms) <- c("id",
                           "area_name",
                           "imd_avg_sc",
                           "income_avg_sc",
                           "employ_avg_sc",
                           "educ_skill_avg_sc",
                           "health_avg_sc",
                           "crime_avg_sc",
                           "housing_avg_sc",
                           "living_env_avg_sc",
                           "IDACI_avg_score",
                           "IDAOPI_avg_score")

# Create IMD quintiles variable
imd_la_subdoms <- mutate(imd_la_subdoms,
                         imd_quintile = ntile(imd_avg_sc, n = 5))

imd_la_subdoms <- imd_la_subdoms[ , c(1:2, 13, 3:12)]

#### Centre and scale variables ####

for(i in 5:ncol(imd_la_subdoms)){
  imd_la_subdoms[,i] <- (imd_la_subdoms[,i] - mean(imd_la_subdoms[,i])) / sd(imd_la_subdoms[,i])
}
```

IMD data were downloaded from the website of the Ministry of Housing, Communities and Local Government (Ministry of Housing, Communities and Local Government 2015). Geographic data were downloaded from the Office for National Statistics Open Geography Portal (geoportal.statistics.gov.uk/datasets/). 

The IMD summary statistics for upper-tier local authorities include a range of scores that summarise the IMD scores of each local authority’s component LSOAs. These include the average of LSOA scores in each sub-domain, and the proportion of LSOAs in a given local authority in the lowest 10% nationally. For simplicity, this study uses only the average scores for each local authority for the seven sub-domains of deprivation. Average scores for each local authority were centered and scaled to mean 0 and standard deviation of 1. This prevents the distribution of any variable affecting its weight in the clustering analysis. All sub-domains were weighted equally.

## Statistical analysis 

This study uses a hierarchical agglomerative (i.e. bottom-up) clustering algorithm. The algorithm computes the Euclidean distance between each local authority based on average scores on the seven sub-domains of deprivation. The algorithm then identifies the two local authorities that have the lowest distance score and links them in a cluster. The algorithm then repeats this process until only one cluster remains containing all the local authorities. A key decision is the choice of linkage method - the method for calculating the distance between clusters and other clusters or points. Here, the ‘complete’ linkage method is used, where the distance between two clusters is the distance between their two farthest points. Sensitivity analysis using other methods were conducted.

Statistical analysis was done in R  version 3.5.0 (R Development Core Team 2008).  Hierarchical clustering was done using the sigclust2 package (Kimes et al. 2017). This package enables testing for statistical significance of clustering. At each node, the algorithm computes the two-mean cluster index, a measure of the extent to which observations within the two clusters vary relative to the overall variation in the data set (small values indicating tighter clustering). The value of the cluster index at each node is then compared to the distribution expected under the null hypothesis that both clusters are drawn from a single gaussian distribution. This produces a p-value for each node in the clustering structure indicating the likelihood that a cluster index that large or larger could have arisen by chance. Nodes with p-values less than 0.001 were treated as statistically significant. To correct for multiple testing, the algorithm applies a family-wise error rate correction, which shrinks the critical value at which the clustering at a given node is judged to be statistically significant. If a node has a p-value greater than 0.001, the algorithm does not test nodes below it in the clustering hierarchy. Using this approach, the number of clusters identified is determined by the significance level, rather than being decided in advance by the researcher, or being based on an arbitrary cut-off point on the clustering tree.

```{r heirarchical clustering, warning=FALSE, message=FALSE}
#### Heirarchical clustering with sigclust2 ####

# Perform clustering with shc()
shc_result <- shc(as.matrix(imd_la_subdoms[,5:11]),
                  linkage = "complete",
                  alpha = 0.001,
                  n_sim = 500)

# Create variable identifying the cluster for each local authority
imd_la_subdoms <- mutate(imd_la_subdoms,
                         cluster = factor(shcutree(shc_result)))
```


# RESULTS

## Hierarchical clustering

Figure 1a shows the clustering structure as a dendrogram. Statistically significant clustering is identified by red branches in the dendrogram, and associated p-values are displayed where the clustering at that node was statistically significant. Five statistically significant clusters were identified. Figure 1b shows the geographic distribution of the five significant clusters.

```{r figure 1, warning=FALSE, message=FALSE, fig.height=15, fig.width=10}
# 1A: Plot dendrogram
fig1a <- plot(shc_result,
              use_labs = FALSE,
              groups = shcutree(shc_result)) + 
       theme_minimal() +
       scale_fill_brewer(type = "qualitative",
                         palette = "Set1",
                         name = "Cluster") +
       labs(title = "Clustering dendrogram") 

# 1B: mapping clusters
# Get map data
if(!file.exists("la_map.Rdata")){
  la_map <- geojson_read("https://opendata.arcgis.com/datasets/d3d7b7538c934cf29db791a705631e24_4.geojson",
                        what = "sp") 
  save(la_map, file = "la_map.Rdata")
}else{
  load("la_map.Rdata")  
}

# Merge imd domain and cluster data with map data
map <- tidy(la_map, region = "ctyua17cd") 
map <- filter(map, !grepl("W", id))
map <- dplyr::left_join(map, imd_la_subdoms)

fig1b <- ggplot(data = map,
                aes(y = lat, 
                    x = long,
                    group = group,
                    fill = cluster)) +
  geom_polygon(col = "black") +
  theme_minimal() +
  labs(title = "Geographic distribution of clusters",
       x = NULL,
       y = NULL) +
  scale_fill_brewer(type = "qualitative",
                    palette = "Set1",
                    name = "Cluster") 

# Plot figures 1a and 1b together.
plot_grid(fig1a, fig1b, 
          nrow = 2,
          labels = "AUTO")

```

Figure 2 and table 1 show the median sub-domain z-scores scores for each of the clusters. 

```{r cluster characteristics}
#### Describe cluster characteristics ####

cluster_table <- imd_la_subdoms %>%
  group_by(cluster) %>%
  dplyr::summarise(n = n(),
            income = median(income_avg_sc),
            health = median(health_avg_sc),
            crime = median(crime_avg_sc),
            employ = median(employ_avg_sc),
            education = median(educ_skill_avg_sc),
            housing = median(housing_avg_sc),
            environment = median(living_env_avg_sc),
            IMD_score = median(imd_avg_sc))

kable(cluster_table)

#### Plot cluster IMD subdomain profiles
ggplot(data = cluster_table %>%
               gather(key = "variable",
                      value = "value",
                      -cluster,
                      -n,
                      -IMD_score,
                      factor_key = TRUE),
             aes(x = variable,
                 y = value,
                 fill = factor(cluster))) +
       geom_bar(stat = "identity") +
       facet_wrap(~factor(cluster)) +
       theme_linedraw() +
       scale_fill_brewer(type = "qualitative",
                          palette = "Set1") +
       theme(axis.text.x = element_text(angle = 90),
             legend.position = c(0.85, 0.0),
             legend.direction = "horizontal",
             legend.title.align = 0.0) +
       guides(fill = guide_legend(ncol = 3,
                                  byrow = TRUE)) +
       labs(x = NULL,
            y = "median sub-domain z-scores",
            fill = "Cluster",
            title = "Figure 2: Cluster deprivation profiles",
            subtitle = "Median sub-domain scores")
```

Cluster 1, the least deprived overall, contains 42 local authorities. Average scores for local authorities in this cluster are low on all sub-domains of deprivation apart from barriers to housing, which are around average. Figure 1b shows that these areas are predominantly rural, with some more affluent boroughs of London. 

Cluster 2, comprising 41 local authorities, has average deprivation scores only slightly above average for income, health, and employment, and slightly below average deprivation in education, but high levels of deprivation in crime, housing, and living environment. These areas include a mix of London boroughs as well as some more rural areas, such as Kirklees and Cornwall.

Cluster 3 (30 local authorities) has a similar overall IMD scores to cluster 2 but experiences low levels of housing and environmental deprivation and average crime levels, but high deprivation in income, employment, health, and education and skills. These areas are mainly post-industrial towns concentrated in the North of England.

Cluster 4 is the most deprived overall. Average deprivation scores are high across all sub-domains except housing. This cluster is relatively small, containing only 15 local authorities, mostly deprived towns and cities in the North and Midlands, such as Blackpool, Liverpool, Manchester, and Wolverhampton.

Cluster 5 (24 local authorities), the second least deprived, scores slightly below average across all sub-domains of deprivation, with lower scores in income and environmental deprivation. This cluster includes a mix of rural and urban local authorities, many county councils, such as Northamptonshire and Lincolnshire, which contain both relatively deprived and relatively affluent areas. 

# DISCUSSION

## Key Findings

## Strengths

## Weaknesses
